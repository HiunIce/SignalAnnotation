<!DOCTYPE html>
<html>

    <head>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.css" rel="stylesheet">
    <script type="text/javascript" src="canvasslider.js"></script>


        <meta charset="utf-8">
        <title>SignalAnnotation</title>

        <script type="text/javascript">
            var pic_id = 1;

            function add(num) {
                pic_exist(pic_id + num, exist => {
                    if (exist) {
                        pic_id += num;
                        change_pic();
                    }
                });
            }   
            function jump() {
                var num = prompt("Please enter number");
                if (!isNaN(num)){
                    pic_exist(num, exist => {
                        if (exist) {
                            pic_id = parseInt(num);
                            change_pic();
                        }
                    });
                }
            }
            function init() {
                document.getElementById('canves').innerHTML = '';
                if (data[pic_id] === undefined){
                    data[pic_id] = [[START,END]];
                }
                s_id = data[pic_id].length;
                data[pic_id].forEach((pair, id) => {
                    add_slide(pair[0], pair[1], id);
                });
                update_canv();
            }
            function change_pic() {
                init();
                document.getElementById('pic_img').src = `${conf['prefix']}${(pic_id).toString()}${conf['suffix']}`;
                document.getElementById('pic_id').innerHTML  = pic_id;
                setTimeout(function(){update_canv();}, 10);
            }
            function update_canv(){
                var ctx = document.getElementById("pic").getContext("2d");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.beginPath();
                var img = document.getElementById("pic_img");

                const x = parseInt(conf['offset_x']), y = parseInt(conf['offset_y']), l = parseInt(conf['rescale_x']), h = parseInt(conf['rescale_y']);
                ctx.drawImage(img, parseInt(x) - (l-500)/2, y - (h-400)/2, l, h);
                data[pic_id].forEach((pair, i) => {
                    draw_line(pair[0]*5, i);
                    draw_line(pair[1]*5, i);
                });
                localStorage.setItem("data", JSON.stringify(data));
            }
            function pic_exist(pic_id, callback) {
                const img = new Image();
                img.src = `${conf['prefix']}${(pic_id).toString()}${conf['suffix']}`;
                if (img.complete) {
                  callback(true);
                } else {
                  img.onload = () => {
                    callback(true);
                  };
                  img.onerror = () => {
                    callback(false);
                  };
                }
            }
        </script>
    </head>

    <body>
        <div>
            <label for="prefix">prefix:</label>
             <input type="text" id="prefix" value="sig" size="2" onchange="config(this.id)">
            <label for="suffix">suffix:</label>
             <input type="text" id="suffix" value=".jpg" size="2" onchange="config(this.id)">
        </div>
        <div>
            <label>offset:</label>
             <!-- <input type="text" id="offset_x" value="0" size="1" onchange="config(this.id)">
             <input type="text" id="offset_y" value="0" size="1" onchange="config(this.id)">  -->
             <input type="range" id="offset_x" value="0" min="-100" max="100" onchange="config(this.id)" oninput="config(this.id)">
             <input type="range" id="offset_y" value="0" min="-100" max="100" onchange="config(this.id)" oninput="config(this.id)">
         </div>
         <div>
            <label>rescale:</label>
             <!-- <input type="text" id="rescale_x" value="500" size="1" onchange="config(this.id)">
             <input type="text" id="rescale_y" value="400" size="1" onchange="config(this.id)"> -->
              <input type="range" id="rescale_x" value="500" min="250" max="1000" onchange="config(this.id)" oninput="config(this.id)">
             <input type="range" id="rescale_y" value="400" min="200" max="800" onchange="config(this.id)" oninput="config(this.id)">
        </div>
        <div>
            <canvas id="pic" width="500" height="400" ></canvas>
            <img id="pic_img" src="./sig1.jpg" hidden/> 
        </div>
        <div>
            <button onclick="add(-1)">prev</button>
            <button onclick="add(1)">next</button>
            <button id="pic_id" onclick="jump(1)">1</button>
            <button onclick="add_slide()">+</button>
            <button onclick="reset()">reset</button>
            <button onclick="saveJsonObjToFile()">save</button>
        </div>
        <div id="canves"></div>
        <br/>
    </body>

<script type="text/javascript">
    var s_id = 0;
    const data_str = localStorage.getItem("data");
    var data = (data_str==null) ? new Map() : JSON.parse(data_str);
    const conf_str = localStorage.getItem("conf");
    var conf = (conf_str==null) ? new Map() : JSON.parse(conf_str);
    const START = 33;
    const END = 67;
    

    function config(k) {
        conf[k] = document.getElementById(k).value;
        localStorage.setItem("conf", JSON.stringify(conf));
        update_canv();
    } 
    function load_conf() {
        if (conf.size === 0){
            ['prefix', 'suffix', 'offset_x', 'offset_y', 'rescale_x', 'rescale_y'].forEach(k => {
                conf[k] = document.getElementById(k).value;
            })
        } else {
            for(var k in conf) {
                document.getElementById(k).value = conf[k];
            }
        }
    }


    function add_slide(s = START, e = END, id = s_id) {
        var node=document.createElement("canvas");
        node.setAttribute("id", "myCanvas" + id);
        node.setAttribute("height", 40);
        node.setAttribute("height", 40);
        node.style.display = "block";
        document.getElementById('canves').appendChild(node);

        const const_id = id;
        var CS = new CanvasSlider({
          canvas: `myCanvas${id}`,
          range: {min: 0, max: 100, step: 1},
          start: [s,e],
          snapToTicks: false,
          showLabels: false,
          showMajorTicks: false,
          showMinorTicks: false,
          showToolTip: false,
          onChange: function(n_id, val) { 
            data[pic_id][const_id][n_id] = val.toFixed(1);
            update_canv();
        },
          format: {decimals: 0, prefix: "", suffix: "%"},
          baseColor: {h: 207, s: 60, v: 100},
          handle: {shape: "ellipse", w: 20, h: 20, hue: 136}

        });

        if (id == s_id) {
            s_id += 1;
            data[pic_id].push([START,END]);
            update_canv();
        }
    }
    window.onload = function() {
        var ctx = document.getElementById("pic").getContext("2d");
        var img = document.getElementById("pic_img");
        ctx.drawImage(img, 0,0);
        load_conf();
        init();
    }

    document.onkeyup = function(e) {
        switch(e.which) {
            case 37: // left
            add(-1);break;
            case 39: // right
            add(1);break;
        }
        e.preventDefault();
    }

    function draw_line(x, i) {
        var context = document.getElementById('pic').getContext("2d");
        context.beginPath();
        context.moveTo(x, 0);
        context.lineTo(x, 400);
        context.lineWidth = 2;
        context.strokeStyle = hslToHex((i*60)%255,100,40);
        context.stroke();
  }

    function reset(){
        data[pic_id] = undefined;
        init()
    }
    function saveJsonObjToFile() {
        const text = JSON.stringify(data);
        const name = "data.json";
        const type = "text/plain";
        const a = document.createElement("a");
        const file = new Blob([text], { type: type });
        a.href = URL.createObjectURL(file);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

  //https://stackoverflow.com/questions/36721830/convert-hsl-to-rgb-and-hex
    function hslToHex(h, s, l) {
      l /= 100;
      const a = s * Math.min(l, 1 - l) / 100;
      const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color).toString(16).padStart(2, '0');   // convert to Hex and prefix "0" if needed
      };
      return `#${f(0)}${f(8)}${f(4)}`;
    }
  
</script>

</html>
